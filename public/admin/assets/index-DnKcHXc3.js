import{r as S,f as k,j as h,al as g,an as V,am as xe,ao as Se,aL as be,az as ye,aM as De,aN as J}from"./index-ZI51y314.js";import{P as he}from"./Table-B6v6YKM6.js";import{_ as Ie}from"./iconUtil-snskxn8a.js";import{b as Q}from"./BaseForm-Dt9roNn_.js";import{b as pe,d as Ce,e as ee,f as Re,g as we,h as Te,C as H,i as _e,n as je,j as P,u as Ee,a as Z,M as Ke,P as Ne,D as Le,c as Oe}from"./core.esm-uR2lXNm7.js";import{u as Me}from"./index-BQOafed3.js";import{R as Ae}from"./HolderOutlined-51iibq6a.js";const Pe=e=>{let{transform:t}=e;return{...t,x:0}};function X(e,t,r){const n=e.slice();return n.splice(r<0?n.length+r:r,0,n.splice(t,1)[0]),n}function $e(e,t){return e.reduce((r,n,a)=>{const s=t.get(n);return s&&(r[a]=s),r},Array(e.length))}function $(e){return e!==null&&e>=0}function ze(e,t){if(e===t)return!0;if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}function Ve(e){return typeof e=="boolean"?{draggable:e,droppable:e}:e}const te=e=>{let{rects:t,activeIndex:r,overIndex:n,index:a}=e;const s=X(t,n,r),o=t[a],u=s[a];return!u||!o?null:{x:u.left-o.left,y:u.top-o.top,scaleX:u.width/o.width,scaleY:u.height/o.height}},z={scaleX:1,scaleY:1},ke=e=>{var t;let{activeIndex:r,activeNodeRect:n,index:a,rects:s,overIndex:o}=e;const u=(t=s[r])!=null?t:n;if(!u)return null;if(a===r){const l=s[o];return l?{x:0,y:r<o?l.top+l.height-(u.top+u.height):l.top-u.top,...z}:null}const v=Be(s,a,r);return a>r&&a<=o?{x:0,y:-u.height-v,...z}:a<r&&a>=o?{x:0,y:u.height+v,...z}:{x:0,y:0,...z}};function Be(e,t,r){const n=e[t],a=e[t-1],s=e[t+1];return n?r<t?a?n.top-(a.top+a.height):s?s.top-(n.top+n.height):0:s?s.top-(n.top+n.height):a?n.top-(a.top+a.height):0:0}const re="Sortable",ne=k.createContext({activeIndex:-1,containerId:re,disableTransforms:!1,items:[],overIndex:-1,useDragOverlay:!1,sortedRects:[],strategy:te,disabled:{draggable:!1,droppable:!1}});function Ge(e){let{children:t,id:r,items:n,strategy:a=te,disabled:s=!1}=e;const{active:o,dragOverlay:u,droppableRects:v,over:l,measureDroppableContainers:d}=pe(),x=Ce(re,r),b=u.rect!==null,i=S.useMemo(()=>n.map(T=>typeof T=="object"&&"id"in T?T.id:T),[n]),y=o!=null,f=o?i.indexOf(o.id):-1,c=l?i.indexOf(l.id):-1,C=S.useRef(i),R=!ze(i,C.current),E=c!==-1&&f===-1||R,I=Ve(s);ee(()=>{R&&y&&d(i)},[R,i,y,d]),S.useEffect(()=>{C.current=i},[i]);const w=S.useMemo(()=>({activeIndex:f,containerId:x,disabled:I,disableTransforms:E,items:i,overIndex:c,useDragOverlay:b,sortedRects:$e(i,v),strategy:a}),[f,x,I.draggable,I.droppable,E,i,c,v,b,a]);return k.createElement(ne.Provider,{value:w},t)}const He=e=>{let{id:t,items:r,activeIndex:n,overIndex:a}=e;return X(r,n,a).indexOf(t)},Xe=e=>{let{containerId:t,isSorting:r,wasDragging:n,index:a,items:s,newIndex:o,previousItems:u,previousContainerId:v,transition:l}=e;return!l||!n||u!==s&&a===o?!1:r?!0:o!==a&&t===v},Fe={duration:200,easing:"ease"},ae="transform",Ye=H.Transition.toString({property:ae,duration:0,easing:"linear"}),qe={roleDescription:"sortable"};function Ue(e){let{disabled:t,index:r,node:n,rect:a}=e;const[s,o]=S.useState(null),u=S.useRef(r);return ee(()=>{if(!t&&r!==u.current&&n.current){const v=a.current;if(v){const l=je(n.current,{ignoreTransform:!0}),d={x:v.left-l.left,y:v.top-l.top,scaleX:v.width/l.width,scaleY:v.height/l.height};(d.x||d.y)&&o(d)}}r!==u.current&&(u.current=r)},[t,r,n,a]),S.useEffect(()=>{s&&o(null)},[s]),s}function We(e){let{animateLayoutChanges:t=Xe,attributes:r,disabled:n,data:a,getNewIndex:s=He,id:o,strategy:u,resizeObserverConfig:v,transition:l=Fe}=e;const{items:d,containerId:x,activeIndex:b,disabled:i,disableTransforms:y,sortedRects:f,overIndex:c,useDragOverlay:C,strategy:R}=S.useContext(ne),E=Je(n,i),I=d.indexOf(o),w=S.useMemo(()=>({sortable:{containerId:x,index:I,items:d},...a}),[x,a,I,d]),T=S.useMemo(()=>d.slice(d.indexOf(o)),[d,o]),{rect:O,node:M,isOver:m,setNodeRef:_}=Re({id:o,data:w,disabled:E.droppable,resizeObserverConfig:{updateMeasurementsFor:T,...v}}),{active:p,activatorEvent:A,activeNodeRect:j,attributes:ie,setNodeRef:F,listeners:se,isDragging:B,over:ue,setActivatorNodeRef:de,transform:ce}=we({id:o,data:w,attributes:{...qe,...r},disabled:E.draggable}),le=Te(_,F),K=!!p,Y=K&&!y&&$(b)&&$(c),q=!C&&B,U=q&&Y?ce:null,fe=Y?U??(u??R)({rects:f,activeNodeRect:j,activeIndex:b,overIndex:c,index:I}):null,L=$(b)&&$(c)?s({id:o,items:d,activeIndex:b,overIndex:c}):I,N=p==null?void 0:p.id,D=S.useRef({activeId:N,items:d,newIndex:L,containerId:x}),ge=d!==D.current.items,W=t({active:p,containerId:x,isDragging:B,isSorting:K,id:o,index:I,items:d,newIndex:D.current.newIndex,previousItems:D.current.items,previousContainerId:D.current.containerId,transition:l,wasDragging:D.current.activeId!=null}),G=Ue({disabled:!W,index:I,node:M,rect:O});return S.useEffect(()=>{K&&D.current.newIndex!==L&&(D.current.newIndex=L),x!==D.current.containerId&&(D.current.containerId=x),d!==D.current.items&&(D.current.items=d)},[K,L,x,d]),S.useEffect(()=>{if(N===D.current.activeId)return;if(N&&!D.current.activeId){D.current.activeId=N;return}const me=setTimeout(()=>{D.current.activeId=N},50);return()=>clearTimeout(me)},[N]),{active:p,activeIndex:b,attributes:ie,data:w,rect:O,index:I,newIndex:L,items:d,isOver:m,isSorting:K,isDragging:B,listeners:se,node:M,overIndex:c,over:ue,setNodeRef:le,setActivatorNodeRef:de,setDroppableNodeRef:_,setDraggableNodeRef:F,transform:G??fe,transition:ve()};function ve(){if(G||ge&&D.current.newIndex===I)return Ye;if(!(q&&!_e(A)||!l)&&(K||W))return H.Transition.toString({...l,property:ae})}}function Je(e,t){var r,n;return typeof e=="boolean"?{draggable:e,droppable:!1}:{draggable:(r=e==null?void 0:e.draggable)!=null?r:t.draggable,droppable:(n=e==null?void 0:e.droppable)!=null?n:t.droppable}}P.Down,P.Right,P.Up,P.Left;var Qe=["DragHandle","dragSortKey"],Ze=["dragSortKey"],oe=S.createContext({handle:null}),et=function(t){var r=We({id:t.id}),n=r.attributes,a=r.listeners,s=r.setNodeRef,o=r.transform,u=r.transition,v=g({transform:H.Transform.toString(o),transition:u},t==null?void 0:t.style),l=t.DragHandle,d=t.dragSortKey,x=V(t,Qe);if(d){var b=[];return k.Children.forEach(x.children,function(i,y){if(i.key===d){var f,c;b.push(h.jsx(oe.Provider,{value:{handle:h.jsx(l,g(g({rowData:i==null||(f=i.props)===null||f===void 0?void 0:f.record,index:i==null||(c=i.props)===null||c===void 0?void 0:c.index},a),n))},children:i},i.key||y));return}b.push(i)}),h.jsx("tr",g(g({},x),{},{ref:s,style:v,children:b}))}return h.jsx("tr",g(g(g({},x),{},{ref:s,style:v},n),a))},tt=k.memo(function(e){e.dragSortKey;var t=V(e,Ze),r=S.useContext(oe),n=r.handle;return n?h.jsx("td",g(g({},t),{},{children:h.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[n," ",t.children]})})):h.jsx("td",g({},t))}),rt=function(t){return h.jsx("tbody",g({},t))};function nt(e){var t=e.dataSource,r=t===void 0?[]:t,n=e.onDragSortEnd,a=e.DragHandle,s=e.dragSortKey,o=Ee(Z(Ne),Z(Ke)),u=S.useCallback(function(i){var y,f=i.active,c=i.over;if(c!=null&&(y=c.id)!==null&&y!==void 0&&y.toString()&&f.id!==(c==null?void 0:c.id)){var C=X(r||[],parseInt(f.id),parseInt(c.id));n==null||n(parseInt(f.id),parseInt(c.id),C||[])}},[r,n]),v=Q(function(i){return h.jsx(Ge,{items:r.map(function(y,f){return f==null?void 0:f.toString()}),strategy:ke,children:h.jsx(rt,g({},i))})}),l=Q(function(i){var y,f=Object.assign({},(Ie(i),i)),c=(y=r.findIndex(function(C){var R;return C[(R=e.rowKey)!==null&&R!==void 0?R:"index"]===f["data-row-key"]}))===null||y===void 0?void 0:y.toString();return h.jsx(et,g({id:c,dragSortKey:s,DragHandle:a},f),c)}),d=e.components||{};if(s){var x;d.body=g({wrapper:v,row:l,cell:tt},((x=e.components)===null||x===void 0?void 0:x.body)||{})}var b=S.useMemo(function(){return function(i){return h.jsx(Le,{modifiers:[Pe],sensors:o,collisionDetection:Oe,onDragEnd:u,children:i.children})}},[u,o]);return{DndContext:b,components:d}}var at=function(t){return xe({},t.componentCls,{"&-icon":{marginInlineEnd:8,color:t.colorTextSecondary,cursor:"grab !important",padding:4,fontSize:12,borderRadius:t.borderRadius,"&:hover":{color:t.colorText,backgroundColor:t.colorInfoBg}}})};function ot(e){return Me("DragSortTable",function(t){var r=g(g({},t),{},{componentCls:".".concat(e)});return[at(r)]})}var it=["rowKey","dragSortKey","dragSortHandlerRender","onDragSortEnd","onDataSourceChange","defaultData","dataSource","onLoad"],st=["rowData","index","className"];function xt(e){var t,r=e.rowKey,n=e.dragSortKey,a=e.dragSortHandlerRender,s=e.onDragSortEnd,o=e.onDataSourceChange,u=e.defaultData,v=e.dataSource,l=e.onLoad,d=V(e,it),x=S.useContext(Se.ConfigContext),b=x.getPrefixCls,i=be(function(){return u||[]},{value:v,onChange:o}),y=ye(i,2),f=y[0],c=y[1],C=ot(b("pro-table-drag")),R=C.wrapSSR,E=C.hashId,I=S.useMemo(function(){return function(m){m.rowData,m.index;var _=m.className,p=V(m,st),A=h.jsx(Ae,g(g({},p),{},{className:"".concat(b("pro-table-drag-icon")," ").concat(_||""," ").concat(E||"").trim()})),j=a?a(m==null?void 0:m.rowData,m==null?void 0:m.index):A;return h.jsx("div",g(g({},p),{},{children:j}))}},[b]),w=nt({dataSource:f==null?void 0:f.slice(),dragSortKey:n,onDragSortEnd:s,components:e.components,rowKey:r,DragHandle:I}),T=w.components,O=w.DndContext,M=function(){var m=De(J().mark(function _(p){return J().wrap(function(j){for(;;)switch(j.prev=j.next){case 0:return c(p),j.abrupt("return",l==null?void 0:l(p));case 2:case"end":return j.stop()}},_)}));return function(p){return m.apply(this,arguments)}}();return R(h.jsx(he,g(g({},d),{},{columns:(t=d.columns)===null||t===void 0?void 0:t.map(function(m){return(m.dataIndex==n||m.key===n)&&(m.render||(m.render=function(){return null})),m}),onLoad:M,rowKey:r,tableViewRender:function(_,p){return h.jsx(O,{children:p})},dataSource:f,components:T,onDataSourceChange:o})))}export{xt as D};
